<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>API Keys - Rate Limiter Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body { background: #f8f9fa; }
    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .page-header {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .api-key-box {
      background: #f8f9fa;
      padding: 0.5rem;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      transition: background 0.3s;
    }
    .api-key-box:hover { background: #e9ecef; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="bi bi-speedometer2 me-2"></i><strong>Rate Limiter Admin</strong></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" th:href="@{/admin/dashboard}"><i class="bi bi-house me-1"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" th:href="@{/admin/companies}"><i class="bi bi-building me-1"></i>Companies</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/admin/rules}"><i class="bi bi-sliders me-1"></i>Rules</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/admin/logout}"><i class="bi bi-box-arrow-right me-1"></i>Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a th:href="@{/admin/companies}"><i class="bi bi-building me-1"></i>Companies</a></li>
      <li class="breadcrumb-item active" aria-current="page" th:text="${company.name}"></li>
    </ol>
  </nav><div class="page-header">
  <h1><i class="bi bi-key me-2"></i>API Keys for <span th:text="${company.name}"></span></h1>
  <p class="text-muted mb-0">Generate and manage API keys for this company</p>
</div><div id="alertContainer"></div>

  <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle-fill me-2"></i><span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- Generate API Key -->
  <div class="card mb-4">
    <div class="card-body">
      <form id="generateKeyForm" th:action="@{/admin/companies/{id}/apikeys/generate(id=${company.id})}" method="post" class="d-inline">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit" class="btn btn-primary" id="generateBtn">
          <i class="bi bi-plus-circle me-2"></i>Generate New API Key
        </button>
      </form>
    </div>
  </div>

  <!-- API Keys List -->
  <div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Existing API Keys</h5>
      <span class="badge bg-primary" th:text="${apiKeys.size()} + ' keys'"></span>
    </div>
    <div class="card-body">
      <div th:if="${#lists.isEmpty(apiKeys)}" class="text-center text-muted py-4">
        <i class="bi bi-key display-4"></i>
        <p class="mt-3">No API keys found. Generate one above.</p>
      </div>
      <div th:unless="${#lists.isEmpty(apiKeys)}">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="apiKeysTable">
            <thead class="table-light">
            <tr>
              <th style="width: 40%">Key</th>
              <th>Status</th>
              <th>Created At</th>
              <th class="text-center">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="apiKey : ${apiKeys}" th:data-key-id="${apiKey.id}">
              <td>
                <div class="api-key-box" onclick="copyToClipboard(this)" th:title="'Click to copy'">
                  <code th:text="${apiKey.keyValue}"></code>
                  <i class="bi bi-clipboard ms-2"></i>
                </div>
              </td>
              <td>
                <span th:if="${apiKey.active}" class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>
                <span th:unless="${apiKey.active}" class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Revoked</span>
              </td>
              <td><small th:text="${#temporals.format(apiKey.createdAt, 'yyyy-MM-dd HH:mm')}"></small></td>
              <td class="text-center">
                <button th:if="${apiKey.active}"
                        class="btn btn-sm btn-outline-warning revoke-btn"
                        th:data-key-id="${apiKey.id}"
                        th:data-company-id="${company.id}">
                  <i class="bi bi-slash-circle"></i> Revoke
                </button>
                <span th:unless="${apiKey.active}" class="text-muted">—</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const csrfToken = document.querySelector('meta[name="_csrf"]').content;
  const companyId = [[${company.id}]];

  // Generate API Key with AJAX
  document.getElementById('generateKeyForm').addEventListener('submit', function(e) {
    e.preventDefault();

    fetch(`/admin/companies/${companyId}/apikeys/generate`, {
      method: 'POST',
      headers: { 'X-CSRF-TOKEN': csrfToken }
    })
            .then(response => response.ok ? response.text() : Promise.reject('Failed'))
            .then(() => {
              showAlert('success', 'API Key generated successfully!');
              setTimeout(() => location.reload(), 1000);
            })
            .catch(() => showAlert('danger', 'Failed to generate API key'));
  });

  // Revoke API Key with AJAX
  document.querySelectorAll('.revoke-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const keyId = this.dataset.keyId;
      const companyId = this.dataset.companyId;

      if (!confirm('Revoke this API key? This action cannot be undone.')) return;

      fetch(`/admin/companies/${companyId}/apikeys/${keyId}/revoke`, {
        method: 'POST',
        headers: { 'X-CSRF-TOKEN': csrfToken }
      })
              .then(response => response.ok ? response.text() : Promise.reject('Failed'))
              .then(() => {
                showAlert('success', 'API Key revoked');
                const row = document.querySelector(`tr[data-key-id="${keyId}"]`);
                row.querySelector('.badge').innerHTML = '<i class="bi bi-x-circle me-1"></i>Revoked';
                row.querySelector('.badge').classList.replace('bg-success', 'bg-danger');
                this.parentElement.innerHTML = '<span class="text-muted">—</span>';
              })
              .catch(() => showAlert('danger', 'Failed to revoke API key'));
    });
  });

  function copyToClipboard(element) {
    const text = element.querySelector('code').textContent;
    navigator.clipboard.writeText(text).then(() => {
      showAlert('success', 'API Key copied to clipboard!');
    });
  }

  function showAlert(type, message) {
    const alertContainer = document.getElementById('alertContainer');
    alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
    setTimeout(() => alertContainer.innerHTML = '', 3000);
  }
</script>
</body>
</html>
