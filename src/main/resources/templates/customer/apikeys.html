<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>API Keys - Rate Guard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .page-header {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .api-key-box {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .api-key-box:hover {
            background: #e9ecef;
            transform: scale(1.02);
        }
        .btn-action {
            padding: 0.375rem 0.875rem;
            border-radius: 8px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}"><i class="bi bi-shield-lock-fill me-2"></i><strong>Rate Guard</strong></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" th:href="@{/}"><i class="bi bi-house-door me-1"></i>Home</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/customer/dashboard}"><i class="bi bi-house-door me-1"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link active" th:href="@{/customer/apikeys}"><i class="bi bi-key me-1"></i>API Keys</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/customer/rules}"><i class="bi bi-sliders me-1"></i>Rules</a></li>
                <li class="nav-item"><a class="nav-link" href="/docs"><i class="bi bi-book me-1"></i>Docs</a></li>
            </ul>
            <ul class="navbar-nav">
                <!-- Logout Form -->
                <form method="post" th:action="@{/customer/logout}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </button>
                </form>

            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="page-header">
        <h1><i class="bi bi-key me-2"></i>Your API Keys</h1>
        <p class="text-muted mb-0">Generate and manage API keys for your applications</p>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Server-side messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show server-success-message">
        <i class="bi bi-check-circle-fill me-2"></i><span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Generate API Key -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="generateKeyForm" th:action="@{/customer/apikeys/generate}" method="post" class="d-inline">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-primary" id="generateBtn">
                    <span id="generateBtnText">
                        <i class="bi bi-plus-circle me-2"></i>Generate New API Key
                    </span><span id="generateBtnSpinner" class="d-none">
                        <span class="spinner-border spinner-border-sm me-2"></span>Generating...
                    </span>
                </button>
            </form>
            <small class="text-muted ms-3">
                <i class="bi bi-info-circle me-1"></i>Store your API key securely. You won't be able to see it again.
            </small>
        </div>
    </div>

    <!-- API Keys List -->
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Your API Keys</h5>
            <span class="badge bg-primary" id="keyCount" th:text="${totalKeyCount} + ' keys'"></span>
        </div>
        <div class="card-body">
            <div id="noKeysMsg" th:if="${totalKeyCount == 0}" class="text-center text-muted py-5">
                <i class="bi bi-key display-1"></i>
                <p class="mt-3 lead">No API keys yet</p>
                <p>Click "Generate New API Key" above to create your first key</p>
            </div>

            <!-- Active Keys -->
            <div th:if="${not #lists.isEmpty(activeApiKeys)}" class="mb-4">
                <h6>Active Keys</h6>
                <div class="table-responsive">
                    <table class="table table-hover" id="activeApiKeysTable">
                        <thead>
                        <tr>
                            <th>API Key</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="key : ${activeApiKeys}" th:data-key-id="${key.id}">
                            <td>
                                <div class="api-key-box" th:title="'Created: ' + ${#temporals.format(key.createdAt, 'MMM dd, yyyy HH:mm')}">
                                    <code th:text="${#strings.concat(#strings.substring(key.keyValue,0,8),'…', #strings.substring(key.keyValue, #strings.length(key.keyValue) - 4, #strings.length(key.keyValue)))}"></code>
                                </div>
                            </td>
                            <td th:text="${#temporals.format(key.createdAt, 'MMM dd, yyyy HH:mm')}"></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger btn-action revoke-btn" th:data-key-id="${key.id}">
                                    <i class="bi bi-x-circle me-1"></i>Revoke
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Revoked Keys -->
            <div th:if="${not #lists.isEmpty(revokedApiKeys)}">
                <h6 class="mt-3">Revoked Keys</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="revokedApiKeysTable">
                        <thead>
                        <tr>
                            <th>API Key (revoked)</th>
                            <th>Created</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="key : ${revokedApiKeys}">
                            <td>
                                <div class="api-key-box text-muted" th:title="'Created: ' + ${#temporals.format(key.createdAt, 'MMM dd, yyyy HH:mm')}">
                                    <code th:text="${#strings.concat(#strings.substring(key.keyValue,0,8),'…', #strings.substring(key.keyValue, #strings.length(key.keyValue) - 4, #strings.length(key.keyValue)))}"></code>
                                </div>
                            </td>
                            <td th:text="${#temporals.format(key.createdAt, 'MMM dd, yyyy HH:mm')}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reveal Modal (inserted dynamically when needed) -->
<div class="modal fade" id="revealKeyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">API Key</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">This is your newly generated API key. Save it now — it will not be shown again.</p>
        <pre id="revealedKey" class="bg-light p-2" style="word-break:break-all;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="copyRevealedKeyBtn" class="btn btn-primary">Copy key</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    // Hide server-provided API keys in flash messages and offer explicit reveal
    (function handleServerSuccessMessage() {
        const successAlert = document.querySelector('.server-success-message');
        if (!successAlert) return;

        const span = successAlert.querySelector('span');
        if (!span) return;

        const text = span.textContent || '';
        // Expecting server message like: "API Key generated: <key>" - extract key if present
        const match = text.match(/API Key generated:\s*(rl_[A-Za-z0-9_-]+|[A-Za-z0-9-]{8,})/i);
        if (match && match[1]) {
            let fullKey = match[1];
             // Remove the raw key from the visible alert
             span.textContent = 'API Key generated — click "Reveal" to view and copy the key (will be shown only once).';

             // Add a reveal button inside the alert
             const revealBtn = document.createElement('button');
             revealBtn.className = 'btn btn-sm btn-outline-primary ms-3';
             revealBtn.textContent = 'Reveal';
             revealBtn.type = 'button';
             successAlert.insertBefore(revealBtn, successAlert.querySelector('.btn-close'));

             // On click, show modal with key and copy button. The full key is kept only in JS memory (not visible in DOM until modal shown)
             revealBtn.addEventListener('click', function () {
                const revealedKeyEl = document.getElementById('revealedKey');
                // Show the key in the modal and select it for easy manual copying
                revealedKeyEl.textContent = fullKey;

                const revealModalEl = document.getElementById('revealKeyModal');
                const revealModal = new bootstrap.Modal(revealModalEl);
                revealModal.show();

                // Helper to select the key text so user can copy easily
                function selectText(el) {
                    try {
                        const range = document.createRange();
                        range.selectNodeContents(el);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    } catch (e) {
                        // ignore selection errors
                    }
                }

                // Select content after a small delay to ensure modal is visible
                setTimeout(() => selectText(revealedKeyEl), 50);

                const copyBtn = document.getElementById('copyRevealedKeyBtn');
                // Copy without auto-closing; keep key visible until the modal is closed explicitly by the user
                copyBtn.onclick = function () {
                    navigator.clipboard.writeText(fullKey).then(() => {
                        showAlert('success', 'API Key copied to clipboard!');
                        // Leave the key visible so the user can verify or copy again; we'll clear it when the modal is closed
                    }).catch(() => showAlert('danger', 'Failed to copy to clipboard'));
                };

                // When modal is hidden, clear the revealed key text and memory
                revealModalEl.addEventListener('hidden.bs.modal', function () {
                    revealedKeyEl.textContent = '';
                    fullKey = null;
                }, { once: true });
             });
         }
     })();

     // Generate API Key with AJAX
     document.getElementById('generateKeyForm').addEventListener('submit', function(e) {
         e.preventDefault();

         const generateBtn = document.getElementById('generateBtn');
         const generateBtnText = document.getElementById('generateBtnText');
         const generateBtnSpinner = document.getElementById('generateBtnSpinner');

         // Show loading
         generateBtn.disabled = true;
         generateBtnText.classList.add('d-none');
         generateBtnSpinner.classList.remove('d-none');

         fetch('/customer/apikeys/generate', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 'X-Requested-With': 'XMLHttpRequest',
                 [csrfHeader]: csrfToken  // Use variable header name
             },
             body: JSON.stringify({})
         })
             .then(response => response.json().then(body => ({ status: response.status, body })))
             .then(({ status, body }) => {
                 if (status >= 400) throw new Error(body.error || 'Failed');
                 // Show reveal modal with returned key
                 if (body.apiKey) {
                    let revealedKey = body.apiKey;
                     const revealedKeyEl = document.getElementById('revealedKey');
                     revealedKeyEl.textContent = revealedKey;

                     const revealModalEl = document.getElementById('revealKeyModal');
                     const revealModal = new bootstrap.Modal(revealModalEl);
                     revealModal.show();

                     // Select text to help manual copy
                     function selectText(el) {
                         try {
                             const range = document.createRange();
                             range.selectNodeContents(el);
                             const sel = window.getSelection();
                             sel.removeAllRanges();
                             sel.addRange(range);
                         } catch (e) {}
                     }
                     setTimeout(() => selectText(revealedKeyEl), 50);

                     const copyBtn = document.getElementById('copyRevealedKeyBtn');
                     copyBtn.onclick = function () {
                        navigator.clipboard.writeText(revealedKey).then(() => {
                            showAlert('success', 'API Key copied to clipboard!');
                            // keep visible until modal is closed
                        }).catch(() => showAlert('danger', 'Failed to copy to clipboard'));
                     };

                     // When the modal is closed by the user, clear and then reload to refresh the masked list
                     revealModalEl.addEventListener('hidden.bs.modal', function () {
                        revealedKeyEl.textContent = '';
                        revealedKey = null;
                        // reload once the modal is closed so the list reflects the new key (masked)
                        location.reload();
                     }, { once: true });
                 } else {
                     showAlert('success', 'API Key generated');
                     setTimeout(() => location.reload(), 800);
                 }
             })
             .catch(err => {
                 console.error('Error:', err);
                 showAlert('danger', 'Failed to generate API key');
                 generateBtn.disabled = false;
                 generateBtnText.classList.remove('d-none');
                 generateBtnSpinner.classList.add('d-none');
             });
     });

    // Revoke API Key with AJAX
    document.querySelectorAll('.revoke-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const keyId = this.dataset.keyId;

            if (!confirm('Revoke this API key? This action cannot be undone.')) return;

            fetch(`/customer/apikeys/${keyId}/revoke`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken  // Use variable header name
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed');
                    return response.text();
                })
                .then(() => {
                    showAlert('success', 'API Key revoked successfully');
                    const row = document.querySelector(`tr[data-key-id="${keyId}"]`);
                    row.querySelector('.badge').innerHTML = '<i class="bi bi-x-circle me-1"></i>Revoked';
                    row.querySelector('.badge').classList.replace('bg-success', 'bg-danger');
                    this.parentElement.innerHTML = '<span class="text-muted">—</span>';
                })
                .catch(err => {
                    console.error('Error:', err);
                    showAlert('danger', 'Failed to revoke API key');
                });
        });
    });


    function showAlert(type, message) {
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        setTimeout(() => alertContainer.innerHTML = '', 3000);
    }
</script>
</body>
</html>
